<div id ="calendrier_mensuel">
<h3> <?php echo $this->escape($this->title); ?>  </h3>
	<div id ="filtre_ressources">
		<h4> <?php echo $this->escape($this->title_filtre); ?>  </h4>
				<div id="filtres_calendrier">
					<ol>
						</br>
						<li><strong>Entite</strong></li>
						</br>
						<li><strong>Pole</strong></li>
						</br>
						<li><strong>Fonction</strong></li>
					</ol>			
				</div>

	<?php echo $this->form; ?>	
	</div>

	<div id ="filtre_periode">
		<h4> <?php echo $this->escape($this->title_choix); ?>  </h4>
		<div id="filtres_periode">
			<ol>
				</br>
				<li><strong>Choisir Un mois</strong></li>
				</br>
				<li><strong>Choisir Une annee</strong></li>
			
			</ol>			
		</div>

<?php echo $this->form2."</br>"; ?>
<?php echo $this->form3."</br>"; ?>
</div>

</div>

<div id ="bande_milieu">
<h5>                                 </h5>
</div>






<?php

//list($dcourt,$day, $month, $year) = explode("/", $date);
$month =$_SESSION['salut']['mois'];


$joursem = array('dim', 'lun', 'mar', 'mer', 'jeu', 'ven', 'sam');
$mois2=array('','Janvier','Fevrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Decembre');
$numjour1= array(0, 1, 2, 3, 4,5,6); // 0 pour un dimanche et 6 pour un samedi

$timestamp = mktime (0, 0, 0, $month, 01, $_SESSION['salut']['annee']/*$year*/);
 
$numjour= $numjour1[date("w",$timestamp)]; // le numero du jour du debut de mois 

// nombre de jours du mois
$nombreDeJoursDeMois = intval(date("t",$timestamp));

/*
 * recuperation le nombre de jours ouvres sur le mois actuel
 */
		$fin_mois=date('Y-m-d',mktime(0,0,0,$month+1,0,$_SESSION['salut']['annee']));
		$debut_mois=date('Y-m-d',mktime(0,0,0,$month,1,$_SESSION['salut']['annee']));
		$conge = new Default_Model_Conge();
		$propostion = new Default_Model_Proposition();
		// chercher les jours feries de ce mois de conge
		$tableau_jours_feries =$conge->chercher_jours_feriers($debut_mois,$fin_mois);
		
		// Recuperer les jour feries marocain sous un tableau 
			$ferie = new Default_Model_Ferie();
			$jours_feries_marocain = $ferie->RecupererLesJoursFeries( $_SESSION['salut']['annee']);
			$nb= count($jours_feries_marocain );
			$tableau = array();
			for ($i=0;$i<$nb;$i++)
			{
					$tableau[$i] = $jours_feries_marocain[$i]['date_debut'];		
			}

$month_t=intval(date("n")); // on recepure le numumro du mois avec la fonction interval on peut avoir un num entier ( s'assurer)
// affichage du mois par son nom

?>

<div id="divtable">

<table id="tablecalendar">

<?php
echo "<p> calendrier du mois  ".$mois2[$_SESSION['salut']['mois']]." ".$_SESSION['salut']['annee']."</p>";
$L=1;
$r=0;
$t=0;
$d=0;
$f=0;
$mt =0;



while ($L <= count($this->calendrierArray)+1 ) //  c'est le nombre des ressources et c'est le meme le nombre de lignes remplace le par le $nombre_ligne
{
	// aide pour les calcule des jour ferie et valorisés au niveau du calendrier 
	$var = strtotime($debut_mois );

?>



<tr>
	
	<?php
	$j = 0;
	while ($j<= ($nombreDeJoursDeMois+1) ) //  est le nombre des jours dans le mois à traiter et c'est  meme le nombre de colonnes
	{
		
		$s =0;
	?>
			<td <?php if ($L!=1 && $j !=0){echo 'class="colonne"'; }?>>
		      
				<?php 
					if ($L==1 && $j ==0){ echo "";}
					elseif ($L==1 && $j ==($nombreDeJoursDeMois)+1){ echo "NbJ";} 
					elseif ($L!=1 && $j ==($nombreDeJoursDeMois)+1)
					{
						    // affichage NBR JOURS dans calendrier MTA : 
						    echo $this->calendrierArray[$L-2][0]['nombre_jours'];  // MTA : resultat correcte mais négatif * -1 
						
					} 
					elseif ($L!=1 && $j ==0)
					{ 
						?>
						<a href="<?php echo $this->url(array('id'=>$this->calendrierArray[$r][$s]['id'], 'controller' => 'calendrier', 'action' => 'calendrierannuel'), 'default', true) ?>" > 
						<?php echo $this->calendrierArray[$r][$s]['nom'];$r++;?> </a>
						<?php
					} 
					elseif ($L==1 && $j !=0){ echo $j;} 
					/*
					 * numjour represente les jours de la semanaine il va verifier sur le mois ou le  conge est pris
					 * les jours de conge pour les colores en couluers correspond au type de conge (switch) et week en gris 
					 */ 
					
					elseif ($L!=1 && $j !=0)
					{
							$flag2 =0;
						/*
						 * apartir de cette ligne jusqu'au la ligne 119 c'est  pour la valorisation des jours ferier francais au niveau du 
						 * calendirer mensuel
						 */ 
						
						//echo "la valeur de var est :".date(date('Y', $var).'-m-d', $var);
						
						// ((date (j_n_y) in jours_feries_France et centre_service = 0 )  ou  (date (y-m-d) in jours_feries_maroc et centre_service = 1 )) et ni (samedi/dimanche)
						if((((in_array(date('j_n_'.date('Y', $var), $var), $tableau_jours_feries)) && ($this->calendrierArray[$L-2][$s]['centre_service']==0))||((in_array(date(date('Y', $var).'-m-d', $var), $tableau))&&($this->calendrierArray[$L-2][$s]['centre_service']==1))) && !(in_array(date('w', $var), array(0, 6))) ) 
						{  
							
							
							if ((in_array(date('j_n_'.date('Y', $var), $var), $tableau_jours_feries)) && (in_array(date(date('Y', $var).'-m-d', $var), $tableau)))
							{
								echo  '<div class="FC">FC</div>';
								$flag2 =1;
							}
							if((in_array(date('j_n_'.date('Y', $var), $var), $tableau_jours_feries))&&($this->calendrierArray[$L-2][$s]['centre_service']==0))
							{
								echo  '<div class="FF">FF</div>';
								$flag2 =1;
							}
							if((in_array(date(date('Y', $var).'-m-d', $var), $tableau))&&($this->calendrierArray[$L-2][$s]['centre_service']==1))
							{   
								echo  '<div class="FF">FM</div>';
								$flag2 =1;
							}
							
							 $numjour++;
								
						}	
						
						/*
						 * jusu'au 149 c'est pour valoriser les jours de conges selon le type du conge ainsi les jours de week-end en gris
						 */
						
						/* MTA : Mohamed khalil TAKAFI */
						for ($i=0;$i<count($this->calendrierArray[$L-2]);$i++)
						{
							
							if ( ( ($this->calendrierArray[$L-2][$i]['date_debut']->get(Zend_Date::MONTH)<$_SESSION['salut']['mois'] &&$this->calendrierArray[$L-2][$i]['date_fin']->get(Zend_Date::MONTH)==$_SESSION['salut']['mois'] && $j <=$this->calendrierArray[$L-2][$i]['date_fin']->get(Zend_Date::DAY))||($this->calendrierArray[$L-2][$i]['date_debut']->get(Zend_Date::MONTH)==$_SESSION['salut']['mois'] &&$this->calendrierArray[$L-2][$i]['date_fin']->get(Zend_Date::MONTH)>$_SESSION['salut']['mois'] && $j >=$this->calendrierArray[$L-2][$i]['date_debut']->get(Zend_Date::DAY))||($this->calendrierArray[$L-2][$i]['date_debut']->get(Zend_Date::MONTH)== $_SESSION['salut']['mois']-1 && $j <=$this->calendrierArray[$L-2][$i]['date_fin']->get(Zend_Date::DAY))||($this->calendrierArray[$L-2][$i]['date_debut']->get(Zend_Date::DAY)<=$j && $j <=$this->calendrierArray[$L-2][$i]['date_fin']->get(Zend_Date::DAY)) ||($this->calendrierArray[$L-2][$i]['date_debut']->get(Zend_Date::DAY)<=$j &&($this->calendrierArray[$L-2][$i]['date_fin']->get(Zend_Date::MONTH) == $_SESSION['salut']['mois']+1 ))) && ($numjour != 0 && $numjour !=6 )&&($flag2==0))
							{ 
								$idConge=$this->calendrierArray[$L-2][$i]['id_type_conge'];
								$mi_debut_journee=$this->calendrierArray[$L-2][$i]['mi_debut_journee'];
								$mi_fin_journee=$this->calendrierArray[$L-2][$i]['mi_fin_journee'];
								
								$numjour++;
								$flag =true;
								
								// ( date_debut == date_fin )  et   ( debut_midi == fin_midi )
								if(($this->calendrierArray[$L-2][$i]['date_debut']==$this->calendrierArray[$L-2][$i]['date_fin']) && $mi_fin_journee== $mi_debut_journee)
								{
									echo "<div class=".$idConge."_1>".$idConge."</div>"."<div class=".$this->calendrierArray[$L-2][$i]['id_type_conge2']."_22>".$this->calendrierArray[$L-2][$i]['id_type_conge2']."</div>";

								}
								// ( date_debut != date_fin )  et  (( debut_midi == fin_midi ) et ( fin_midi != 0 ))
								elseif (($this->calendrierArray[$L-2][$i]['date_debut']!=$this->calendrierArray[$L-2][$i]['date_fin']) && $mi_fin_journee == $mi_debut_journee && $mi_fin_journee!= 0 )
								{	
									if ($this->calendrierArray[$L-2][$i]['date_debut']->get(Zend_Date::DAY)==$j)   // MTA : insérer en deuxieme 	
										echo "<div class=".$idConge."_2>".$idConge."</div>";
			
									elseif ($this->calendrierArray[$L-2][$i]['date_fin']->get(Zend_Date::DAY)==$j) // MTA : insérer en premier
											echo "<div class=".$idConge."_1>".$idConge."</div>";
								    else 
											echo "<div class=".$idConge.">".$idConge."</div>";                     // MTA : remplir le tout
								}
								// ( debut_midi = 1)  and  ( date_debut = $j )  // MTA : bug corrigé ! 
								elseif($mi_debut_journee == 1 && ($this->calendrierArray[$L-2][$i]['date_debut']->get(Zend_Date::DAY)==$j))
								{
											echo "<div class=".$idConge."_2>".$idConge."</div>"; // MTA : insérer en deuxieme 	
								}
							    // ( fin_midi = 1) and   ( date_fin = $j )  // MTA : bug corrigé ! 
                               elseif( $mi_fin_journee == 1 && ($this->calendrierArray[$L-2][$i]['date_fin']->get(Zend_Date::DAY)==$j))
                               {
											echo "<div class=".$idConge."_1>".$idConge."</div>"; // MTA : insérer en premier
                               }
							    elseif(1) 
							 		echo "<div class=".$idConge.">".$idConge."</div>";
							 		break ;
							}
						
						}
						
						if ((($numjour == 0 || $numjour ==6)&&($flag==0)&&($flag2==0)))
						{
							echo '<div class="colorgris">WE</div>';
							
							if ($numjour ==6){	$numjour=0;}
							else{ $numjour++;}
						}
						elseif (($flag==0)&&($numjour != 0) && ($numjour !=6)&&($flag2==0))
						{	
							$numjour++;
							echo '<div class="vide"></div>';
						}
					 $var = mktime(date('H', $var), date('i', $var), date('s', $var), date('m', $var), date('d', $var) + 1, date('Y', $var));
					
				}
					$flag = false;
					$flag2 =false;
					
			
					
				?>
			 
			</td>
			
			<?php

		$j++;
		}
	
	?>
	</tr>

	<?php 
	$j=0;
	$numjour =$numjour1[date("w",$timestamp)];
	$L++;
	$s =0;
			// MTA var_dump($tableau_jours_feries);
			// MTA var_dump($this->calendrierArray);
}
?>

</table> 

<a href="<?php  if ($_SESSION['salut']['mois'] == 12){$_SESSION['salut']['mois']=0; $_SESSION['salut']['annee']++;}echo $this->url(array('mois'=> $_SESSION['salut']['mois']+1 ,'annee'=> $_SESSION['salut']['annee'],'controller' => 'calendrier', 'action' => 'calendriermensuel'), 'default', true) ?>" id ="mois_suivant">Mois suivant</a>
<a href="<?php if ($_SESSION['salut']['mois'] == 0 ){$_SESSION['salut']['mois']=12;$_SESSION['salut']['annee']--;}if( $_SESSION['salut']['mois'] == 1){$_SESSION['salut']['mois']=13;$_SESSION['salut']['annee']--;}echo $this->url(array('mois'=> $_SESSION['salut']['mois']-1,'annee'=> $_SESSION['salut']['annee'],'controller' => 'calendrier', 'action' => 'calendriermensuel'), 'default', true) ?>" id ="mois_prece">Mois precedent</a>
<?php
/*
 * la partie en haut du 174 au 176 c'est pour les lien mois suivant et precedant au niveau du calendrier mensuel
 */
?>               
</div>
